import{Bi as e,Oa as t,f as n,ha as r}from"./index-BHNnQTTo.js";var i=`flow_workspace_state`,a=`flow_form_drafts`,o={id:`flow`,type:`flow`,title:`Workspace`,icon:`Home`,closable:!1,pinned:!0};function s(e){let t={id:e.id,type:e.type,title:e.title,icon:e.icon,closable:e.closable,appId:e.appId,dynamic:e.dynamic,route:e.route,doctype:e.doctype,docName:e.docName,isNew:e.isNew,pinned:e.pinned||!1,groupId:e.groupId||null};return e.data&&(t.data={},e.data.application&&(t.data.application={reference:e.data.application.reference,name:e.data.application.name,icon:e.data.application.icon,schema:e.data.application.schema,config:e.data.application.config,workflowDefinition:e.data.application.workflowDefinition}),e.data.initialData&&(t.data.initialData=e.data.initialData),e.data.dataId&&(t.data.dataId=e.data.dataId),e.data.isEdit!==void 0&&(t.data.isEdit=e.data.isEdit),e.data.reference&&(t.data.reference=e.data.reference),e.data.invoiceType&&(t.data.invoiceType=e.data.invoiceType),t.data.loading=!1,t.data.saving=!1),t}function c(e){let t={...e};return t.dynamic&&t.data&&(t.data.loading=!0,t.data.items=[],t.data.totalItems=0),t.unsaved=!1,t.pinned=t.pinned||!1,t.groupId=t.groupId||null,t}const l=n(`workspace`,()=>{let n=t([o]),l=t(`flow`),u=t([]),d=t(!1),f=t({}),p=t([]),m=t({doctype:null,docName:null,timestamp:0}),h=e(()=>n.value.find(e=>e.id===l.value)),g=e(()=>{let e=new Map,t=[],r=[];for(let i of n.value)i.groupId?(e.has(i.groupId)||e.set(i.groupId,[]),e.get(i.groupId).push(i)):i.pinned?t.push(i):r.push(i);let i=[],a=[],o=[];for(let t of p.value){let n=e.get(t.id);if(n&&n.length>0){let e=[{id:`group-header-${t.id}`,type:`group-header`,groupId:t.id,name:t.name,color:t.color,pinned:t.pinned,collapsed:t.collapsed||!1,tabCount:n.length}];t.collapsed||e.push(...n),t.pinned?a.push(...e):o.push(...e)}}return i.push(...a,...t,...o,...r),i}),_=e(()=>{let e=new Map;for(let t of p.value)e.set(t.id,t.color);return e});function v(){if(!d.value){try{let e=localStorage.getItem(i);if(e){let t=JSON.parse(e);if(Array.isArray(t.openTabs)&&t.openTabs.length>0){let e=t.openTabs.some(e=>e.id===`flow`),r=t.openTabs.map(c);e||r.unshift(o),n.value=r}if(Array.isArray(t.tabGroups)){p.value=t.tabGroups;let e=new Set(p.value.map(e=>e.id));for(let t of n.value)t.groupId&&!e.has(t.groupId)&&(t.groupId=null)}t.activeTabId&&n.value.some(e=>e.id===t.activeTabId)&&(l.value=t.activeTabId),Array.isArray(t.tabHistory)&&(u.value=t.tabHistory.filter(e=>n.value.some(t=>t.id===e)))}}catch(e){console.warn(`Failed to hydrate workspace state:`,e),n.value=[o],l.value=`flow`,u.value=[]}d.value=!0}}function y(){try{let e={openTabs:n.value.map(s),activeTabId:l.value,tabHistory:u.value.slice(-50),tabGroups:p.value};localStorage.setItem(i,JSON.stringify(e))}catch(e){console.warn(`Failed to persist workspace state:`,e)}}function b(){try{let e=localStorage.getItem(a);e&&(f.value=JSON.parse(e))}catch(e){console.warn(`Failed to load form drafts:`,e),f.value={}}}function x(){try{localStorage.setItem(a,JSON.stringify(f.value))}catch(e){console.warn(`Failed to persist form drafts:`,e)}}function S(e,t=!0,n=null){return e?t?`new:${e}`:n?`edit:${e}:${n}`:null:null}function C(e,t,n=!0,r=null){let i=S(e,n,r);i&&(f.value[i]={data:t,doctype:e,isNew:n,docName:r,savedAt:new Date().toISOString()},x())}function w(e,t=!0,n=null){let r=S(e,t,n);return r&&f.value[r]||null}function T(e,t=!0,n=null){let r=S(e,t,n);return r?!!f.value[r]:!1}function E(e,t=!0,n=null){let r=S(e,t,n);r&&(delete f.value[r],x())}function D(){f.value={},localStorage.removeItem(a)}function O(e,t){m.value={doctype:e,docName:t,timestamp:Date.now()}}r([n,l],()=>{d.value&&y()},{deep:!0});function k(e){if(v(),n.value.find(t=>t.id===e.id)){l.value!==e.id&&u.value.push(l.value),l.value=e.id;return}u.value.push(l.value),n.value.push({...e,closable:e.closable!==!1}),l.value=e.id}function A(e){v();let t=n.value.findIndex(t=>t.id===e);if(t>-1&&n.value[t].closable!==!1&&(n.value.splice(t,1),u.value=u.value.filter(t=>t!==e),l.value===e)){if(u.value.length>0){let e=u.value.pop();if(n.value.some(t=>t.id===e)){l.value=e;return}}let e=Math.min(t,n.value.length-1);l.value=n.value[e]?.id||`flow`}}function j(e,t={}){v(),n.value.some(t=>t.id===e)&&(!t.skipHistory&&l.value!==e&&u.value.push(l.value),l.value=e)}function M(e){v(),n.value=e,y()}function N(e,t,r){if(e===t)return;let i=n.value.findIndex(t=>t.id===e);if(i===-1)return;let a=n.value[i];if(r===`inside`){let e=null;if(t.startsWith(`group-header-`)){let n=t.replace(`group-header-`,``);e=p.value.find(e=>e.id===n)}else{let r=n.value.find(e=>e.id===t);if(r)if(r.groupId)e=p.value.find(e=>e.id===r.groupId);else{let t=z(`${r.title} Group`,[r.id]);e=p.value.find(e=>e.id===t)}}e&&(a.groupId=e.id,a.pinned=e.pinned,y());return}let o=t.startsWith(`group-header-`),s=o?t.replace(`group-header-`,``):null,c=o?null:n.value.find(e=>e.id===t);o?(a.pinned=p.value.find(e=>e.id===s)?.pinned||!1,a.groupId=null):c&&(a.pinned=c.pinned,a.groupId=c.groupId),n.value.splice(i,1);let l=0;if(o){let e=n.value.filter(e=>e.groupId===s);l=r===`before`?e.length>0?n.value.indexOf(e[0]):n.value.length:e.length>0?n.value.indexOf(e[e.length-1])+1:n.value.length}else c&&(l=n.value.indexOf(c),r===`after`&&l++);n.value.splice(l,0,a),y()}function P(e,t,r){let i=p.value.find(t=>t.id===e);if(!i)return;let a=!1;a=t.startsWith(`group-header-`)?p.value.find(e=>e.id===t.replace(`group-header-`,``))?.pinned||!1:n.value.find(e=>e.id===t)?.pinned||!1,i.pinned=a,n.value.filter(e=>e.groupId===i.id).forEach(e=>e.pinned=a);let o=p.value.indexOf(i);p.value.splice(o,1);let s=p.value.findIndex(e=>t.startsWith(`group-header-`)?e.id===t.replace(`group-header-`,``):n.value.find(e=>e.id===t)?.groupId===e.id);s===-1&&(s=p.value.length),r===`after`&&s++,p.value.splice(s,0,i),y()}function F(){if(u.value.length===0)return!1;let e=u.value.pop();return e&&n.value.some(t=>t.id===e)?(l.value=e,!0):F()}function I(){return u.value.length>0&&u.value.some(e=>n.value.some(t=>t.id===e))}function L(e){let t=n.value.find(t=>t.id===e);t&&(t.pinned=!0,y())}function R(e){let t=n.value.find(t=>t.id===e);t&&(t.pinned=!1,y())}function z(e,t=[],r=`#6366f1`){let i=`grp-${Date.now()}`;p.value.push({id:i,name:e,color:r,pinned:!1,collapsed:!1});for(let e of t){let t=n.value.find(t=>t.id===e);t&&(t.groupId=i)}return y(),i}function B(e,t){let r=n.value.find(t=>t.id===e);r&&p.value.some(e=>e.id===t)&&(r.groupId=t,y())}function V(e){let t=n.value.find(t=>t.id===e);t&&(t.groupId=null,y())}function H(e){let t=p.value.find(t=>t.id===e);t&&(t.pinned=!0,y())}function U(e){let t=p.value.find(t=>t.id===e);t&&(t.pinned=!1,y())}function W(e,t){let n=p.value.find(t=>t.id===e);n&&(n.name=t,y())}function G(e){let t=p.value.find(t=>t.id===e);t&&(t.collapsed=!t.collapsed,y())}function K(e){for(let t of n.value)t.groupId===e&&(t.groupId=null);p.value=p.value.filter(t=>t.id!==e),y()}function q(){localStorage.removeItem(i),localStorage.removeItem(a),n.value=[o],l.value=`flow`,u.value=[],f.value={},p.value=[]}return v(),b(),{openTabs:n,activeTabId:l,tabHistory:u,isHydrated:d,formDrafts:f,docSavedEvent:m,tabGroups:p,activeTab:h,sortedTabs:g,groupColorMap:_,openTab:k,closeTab:A,setActiveTab:j,reorderTabs:M,goBack:F,canGoBack:I,clearPersistedState:q,hydrateState:v,persistState:y,pinTab:L,unpinTab:R,createGroup:z,addToGroup:B,removeFromGroup:V,pinGroup:H,unpinGroup:U,renameGroup:W,toggleGroupCollapsed:G,deleteGroup:K,moveTab:N,moveGroup:P,saveFormData:C,getFormData:w,hasFormData:T,clearFormData:E,clearAllFormDrafts:D,notifyDocSaved:O}});export{l as t};