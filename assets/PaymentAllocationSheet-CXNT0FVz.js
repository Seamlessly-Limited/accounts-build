import"./ConfigProvider-CjeiZORM.js";import"./useHideOthers-BZr43-2a.js";import"./useId-DfGyiNma.js";import"./DialogPortal-CwfqAz4S.js";import"./Teleport-kyzT_9hu.js";import"./utils-DUPUPfs8.js";import"./DialogTitle-BuJgoH9Z.js";import{a as e,i as t,n,o as r,r as i}from"./sheet-zX6i6iKt.js";import{Bi as a,Bt as o,Hi as s,Ki as c,Li as l,Mi as u,Oa as d,Pa as f,Ra as p,Ui as m,Vi as h,Wi as g,ba as _,ca as v,h as y,ha as b,ji as x,o as S,oa as C,qi as w,xa as T}from"./index-Caanq2Pw.js";import{t as E}from"./button-ByjIr43L.js";var ee={key:0,class:`flex justify-center py-8`},te={key:1,class:`space-y-6`},ne={class:`bg-gray-50 rounded-lg p-4 border border-gray-100`},D={class:`grid grid-cols-2 gap-4 text-sm`},O={class:`font-semibold`},k={class:`font-semibold text-amber-600`},A={key:0,class:`border rounded-lg p-4 space-y-4`},j={class:`grid gap-4`},M={class:`space-y-2`},N={class:`space-y-2`},P={class:`space-y-2`},F={class:`space-y-4`},I={key:0,class:`text-sm text-gray-500 italic text-center py-4`},L={key:1,class:`space-y-2`},R={class:`font-medium`},z={class:`text-xs text-gray-500`},B={class:`text-right`},V={class:`font-medium`},H={__name:`PaymentAllocationSheet`,props:{open:Boolean,payment:{type:Object,required:!0}},emits:[`update:open`,`refresh`],setup(H,{emit:U}){let W=H,G=U,{toast:K}=y(),q=d(!1),J=d(!1),Y=d([]),X=d({target_type:`Sales Invoice`,target_id:``,amount:0}),Z=a(()=>{if(!W.payment)return 0;let e=Y.value.filter(e=>e.status!==`Cancelled`).reduce((e,t)=>e+(Number(t.allocated_amount)||0),0);return Math.max(0,(W.payment.amount||0)-e)}),re=a(()=>X.value.target_id&&X.value.amount>0&&X.value.amount<=Z.value);async function Q(){if(W.payment?.name){q.value=!0;try{Y.value=(await S.get(`/org/doc/Payment Allocation`,{params:{filters:JSON.stringify({payment:W.payment.name}),fields:JSON.stringify([`name`,`allocated_amount`,`target_type`,`target_id`,`status`,`currency`,`allocation_date`,`id`])},authorizeRequest:!0,organisationAware:!0})).data?.data||[]}catch(e){console.error(e),Y.value=[]}finally{q.value=!1}}}async function ie(){J.value=!0;try{await S.post(`/org/payments/${W.payment.id}/allocations`,{target_type:X.value.target_type,target_id:X.value.target_id,amount:X.value.amount},{authorizeRequest:!0,organisationAware:!0}),K({title:`Draft Created`,variant:`success`}),X.value={target_type:`Sales Invoice`,target_id:``,amount:0},await Q()}catch(e){K({title:`Failed`,description:e.response?.data?.message||e.message,variant:`destructive`})}finally{J.value=!1}}async function ae(e){if(e.id)try{await S.post(`/org/payments/allocations/${e.id}/submit`,{},{authorizeRequest:!0,organisationAware:!0}),K({title:`Allocated!`,variant:`success`}),await Q(),G(`refresh`)}catch(e){K({title:`Submission Failed`,description:e.response?.data?.message||e.message,variant:`destructive`})}}let $=(e,t)=>new Intl.NumberFormat(`en-NG`,{style:`currency`,currency:t||`NGN`}).format(e||0),oe=e=>e?new Date(e).toLocaleDateString():`-`;return b(()=>W.open,e=>{e&&Q()}),(a,d)=>(C(),s(f(r),{open:H.open,"onUpdate:open":d[3]||=e=>a.$emit(`update:open`,e)},{default:_(()=>[w(f(e),{class:`w-full sm:max-w-xl overflow-y-auto`},{default:_(()=>[w(f(i),{class:`mb-6`},{default:_(()=>[w(f(n),null,{default:_(()=>[...d[4]||=[c(`Payment Allocations`,-1)]]),_:1}),w(f(t),null,{default:_(()=>[...d[5]||=[c(` Manage how this payment is applied to invoices. `,-1)]]),_:1})]),_:1}),q.value?(C(),g(`div`,ee,[w(f(o),{class:`h-8 w-8 animate-spin text-gray-400`})])):(C(),g(`div`,te,[h(`div`,ne,[h(`div`,D,[h(`div`,null,[d[6]||=h(`span`,{class:`text-gray-500 block`},`Payment Amount`,-1),h(`span`,O,p($(H.payment.amount,H.payment.currency)),1)]),h(`div`,null,[d[7]||=h(`span`,{class:`text-gray-500 block`},`Unallocated`,-1),h(`span`,k,p($(Z.value,H.payment.currency)),1)])])]),Z.value>0?(C(),g(`div`,A,[d[13]||=h(`h3`,{class:`font-medium text-sm text-gray-900`},`New Allocation`,-1),h(`div`,j,[h(`div`,M,[d[9]||=h(`label`,{class:`text-xs font-medium text-gray-500`},`Target Type`,-1),T(h(`select`,{"onUpdate:modelValue":d[0]||=e=>X.value.target_type=e,class:`w-full border rounded-md p-2 text-sm bg-white`},[...d[8]||=[h(`option`,{value:`Sales Invoice`},`Sales Invoice`,-1),h(`option`,{value:`Credit Note`},`Credit Note`,-1)]],512),[[x,X.value.target_type]])]),h(`div`,N,[d[10]||=h(`label`,{class:`text-xs font-medium text-gray-500`},`Target ID`,-1),T(h(`input`,{"onUpdate:modelValue":d[1]||=e=>X.value.target_id=e,type:`text`,placeholder:`e.g. INV-2024-001`,class:`w-full border rounded-md p-2 text-sm`},null,512),[[u,X.value.target_id]])]),h(`div`,P,[d[11]||=h(`label`,{class:`text-xs font-medium text-gray-500`},`Amount to Allocate`,-1),T(h(`input`,{"onUpdate:modelValue":d[2]||=e=>X.value.amount=e,type:`number`,step:`0.01`,class:`w-full border rounded-md p-2 text-sm`},null,512),[[u,X.value.amount,void 0,{number:!0}]])]),w(f(E),{onClick:ie,disabled:J.value||!re.value,class:`w-full`},{default:_(()=>[J.value?(C(),s(f(o),{key:0,class:`mr-2 h-4 w-4 animate-spin`})):m(``,!0),d[12]||=c(` Allocate `,-1)]),_:1},8,[`disabled`])])])):m(``,!0),h(`div`,F,[d[15]||=h(`h3`,{class:`font-medium text-sm text-gray-900`},`History`,-1),Y.value.length===0?(C(),g(`div`,I,` No allocations yet. `)):(C(),g(`div`,L,[(C(!0),g(l,null,v(Y.value,e=>(C(),g(`div`,{key:e.name,class:`flex items-center justify-between p-3 border rounded-lg bg-white text-sm`},[h(`div`,null,[h(`div`,R,p(e.target_type)+` - `+p(e.target_id),1),h(`div`,z,p(e.status)+` â€¢ `+p(oe(e.allocation_date)),1)]),h(`div`,B,[h(`div`,V,p($(e.allocated_amount,e.currency)),1),e.status===`Draft`?(C(),s(f(E),{key:0,onClick:t=>ae(e),size:`xs`,variant:`outline`,class:`mt-1 h-6 text-xs border-green-200 text-green-700 hover:bg-green-50`},{default:_(()=>[...d[14]||=[c(` Submit `,-1)]]),_:1},8,[`onClick`])):m(``,!0)])]))),128))]))])]))]),_:1})]),_:1},8,[`open`]))}};export{H as default};