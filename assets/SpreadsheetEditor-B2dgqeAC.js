import{Aa as unref,Ai as withKeys,Bi as createElementBlock,Hi as createTextVNode,It as LoaderCircle,Li as createBaseVNode,Ni as Fragment,Oi as vModelText,Pa as toDisplayString,Qi as nextTick,Ri as createBlock,Ui as createVNode,_a as withDirectives,da as watch,ea as onMounted,ft as Plus,ga as withCtx,ia as renderList,it as Save,ja as normalizeClass,na as openBlock,o as API_default,wa as ref,zi as createCommentVNode}from"./index-BW6FH5S4.js";import{n as Button_default}from"./button-Cg1Yo4L-.js";import{t as Input_default}from"./Input-uGdyVDA7.js";var TableService_default={async getTables(page=0,size=50){return API_default.get(`/org/tables`,{query:{page,size},authorizeRequest:!0,organisationAware:!0})},async searchTables(query){return API_default.get(`/org/tables/search`,{query:{query},authorizeRequest:!0,organisationAware:!0})},async getTable(reference){return API_default.get(`/org/tables/${reference}`,{authorizeRequest:!0,organisationAware:!0})},async createTable(name,description,columns=[]){return API_default.post(`/org/tables`,{data:{name,description,columns},authorizeRequest:!0,organisationAware:!0})},async updateTableData(reference,rows){return API_default.put(`/org/tables/${reference}/data`,{data:{rows},authorizeRequest:!0,organisationAware:!0})},async updateTableColumns(reference,columns){return API_default.put(`/org/tables/${reference}/columns`,{data:{columns},authorizeRequest:!0,organisationAware:!0})},async addRows(reference,rows){return API_default.post(`/org/tables/${reference}/rows`,{data:{rows},authorizeRequest:!0,organisationAware:!0})},async linkToLedger(reference,ledgerReference,columnMapping){return API_default.post(`/org/tables/${reference}/link-ledger`,{data:{ledgerReference,columnMapping},authorizeRequest:!0,organisationAware:!0})},async archiveTable(reference){return API_default.delete(`/org/tables/${reference}`,{authorizeRequest:!0,organisationAware:!0})}},_hoisted_1={class:`flex flex-col h-full bg-white`},_hoisted_2={key:0,class:`flex-1 flex items-center justify-center`},_hoisted_3={class:`flex items-center justify-between px-4 py-2 border-b border-slate-100 bg-slate-50`},_hoisted_4={class:`flex items-center gap-3`},_hoisted_5={class:`text-sm font-medium text-slate-700`},_hoisted_6={class:`flex items-center gap-1`},_hoisted_7={key:0,class:`text-xs text-amber-500 ml-2`},_hoisted_8={class:`flex-1 overflow-auto`},_hoisted_9={class:`w-full border-collapse text-sm`},_hoisted_10={class:`sticky top-0 z-10`},_hoisted_11=[`onUpdate:modelValue`],_hoisted_12=[`onDblclick`],_hoisted_13={class:`w-10 h-8 bg-slate-50 border border-slate-200 text-center text-xs text-slate-500`},_hoisted_14=[`onClick`,`onDblclick`],_hoisted_15={key:1},SpreadsheetEditor_default={__name:`SpreadsheetEditor`,props:{tableReference:String,document:Object},emits:[`change`,`saved`],setup(__props,{emit:__emit}){let props=__props,emit=__emit,loading=ref(!1),saving=ref(!1),tableData=ref(null),columns=ref([]),rows=ref([]),selectedCell=ref(null),editingCell=ref(null),editingValue=ref(``),editingColumnHeader=ref(null),formulaInput=ref(``),cellInput=ref(null),hasChanges=ref(!1);onMounted(async()=>{props.tableReference?await loadTable(props.tableReference):props.document?.data?initializeFromDocument():initializeEmptyGrid()}),watch(()=>props.tableReference,async newRef=>{newRef&&await loadTable(newRef)});async function loadTable(reference){loading.value=!0;try{let response=await TableService_default.getTable(reference);tableData.value=response.data,columns.value=response.data.columns||[],rows.value=response.data.rows||[],columns.value.length===0&&initializeDefaultColumns(),rows.value.length===0&&initializeEmptyRows()}catch(error){console.error(`Failed to load table:`,error),initializeEmptyGrid()}finally{loading.value=!1}}function initializeFromDocument(){props.document?.data?.columns?columns.value=props.document.data.columns:initializeDefaultColumns(),props.document?.data?.rows?rows.value=props.document.data.rows:initializeEmptyRows()}function initializeEmptyGrid(){initializeDefaultColumns(),initializeEmptyRows()}function initializeDefaultColumns(){columns.value=Array(10).fill(null).map((_,i)=>({key:`col_${i}`,title:getColumnName(i),type:`text`,width:100}))}function initializeEmptyRows(){rows.value=Array(20).fill(null).map(()=>({}))}function getColumnName(index){let name=``,i=index;for(;i>=0;)name=String.fromCharCode(i%26+65)+name,i=Math.floor(i/26)-1;return name}function getCellValue(row,colKey){return row[colKey]??``}function selectCell(row,col){selectedCell.value={row,col};let colKey=columns.value[col].key;formulaInput.value=rows.value[row][colKey]||``}function editCell(row,col){editingCell.value={row,col};let colKey=columns.value[col].key;editingValue.value=rows.value[row][colKey]||``,nextTick(()=>{cellInput.value?.focus()})}function saveCell(){if(editingCell.value){let{row,col}=editingCell.value,colKey=columns.value[col].key;rows.value[row][colKey]=evaluateFormula(editingValue.value),editingCell.value=null,hasChanges.value=!0,emit(`change`)}}function cancelEdit(){editingCell.value=null}function evaluateFormula(value){if(value&&value.toString().startsWith(`=`))try{let formula=value.substring(1);return/^[\d\s+\-*/().]+$/.test(formula)?eval(formula):`#ERROR`}catch{return`#ERROR`}return value}function addRow(){rows.value.push({}),hasChanges.value=!0,emit(`change`)}function addColumn(){let newIndex=columns.value.length;columns.value.push({key:`col_${newIndex}`,title:getColumnName(newIndex),type:`text`,width:100}),hasChanges.value=!0,emit(`change`)}async function save(){if(!tableData.value?.reference&&!props.tableReference){console.log(`Creating new table not implemented in this context`);return}saving.value=!0;try{let ref$1=tableData.value?.reference||props.tableReference;await TableService_default.updateTableColumns(ref$1,columns.value),await TableService_default.updateTableData(ref$1,rows.value),hasChanges.value=!1,emit(`saved`)}catch(error){console.error(`Failed to save table:`,error)}finally{saving.value=!1}}return(_ctx,_cache)=>(openBlock(),createElementBlock(`div`,_hoisted_1,[loading.value?(openBlock(),createElementBlock(`div`,_hoisted_2,[createVNode(unref(LoaderCircle),{class:`h-8 w-8 animate-spin text-slate-400`})])):(openBlock(),createElementBlock(Fragment,{key:1},[createBaseVNode(`div`,_hoisted_3,[createBaseVNode(`div`,_hoisted_4,[createBaseVNode(`span`,_hoisted_5,toDisplayString(tableData.value?.name||`Untitled Table`),1),createVNode(unref(Input_default),{modelValue:formulaInput.value,"onUpdate:modelValue":_cache[0]||=$event=>formulaInput.value=$event,placeholder:`Enter formula or value`,class:`w-64 h-8 text-sm font-mono`},null,8,[`modelValue`])]),createBaseVNode(`div`,_hoisted_6,[createVNode(unref(Button_default),{variant:`ghost`,size:`sm`,class:`h-8`,onClick:addRow},{default:withCtx(()=>[createVNode(unref(Plus),{class:`h-3.5 w-3.5 mr-1`}),_cache[4]||=createTextVNode(` Row `,-1)]),_:1}),createVNode(unref(Button_default),{variant:`ghost`,size:`sm`,class:`h-8`,onClick:addColumn},{default:withCtx(()=>[createVNode(unref(Plus),{class:`h-3.5 w-3.5 mr-1`}),_cache[5]||=createTextVNode(` Column `,-1)]),_:1}),_cache[6]||=createBaseVNode(`div`,{class:`w-px h-4 bg-slate-200 mx-2`},null,-1),createVNode(unref(Button_default),{variant:`ghost`,size:`sm`,class:`h-8 w-8 p-0`,onClick:save,disabled:saving.value,title:`Save`},{default:withCtx(()=>[saving.value?(openBlock(),createBlock(unref(LoaderCircle),{key:0,class:`h-4 w-4 animate-spin`})):(openBlock(),createBlock(unref(Save),{key:1,class:`h-4 w-4`}))]),_:1},8,[`disabled`]),hasChanges.value?(openBlock(),createElementBlock(`span`,_hoisted_7,`Unsaved changes`)):createCommentVNode(``,!0)])]),createBaseVNode(`div`,_hoisted_8,[createBaseVNode(`table`,_hoisted_9,[createBaseVNode(`thead`,_hoisted_10,[createBaseVNode(`tr`,null,[_cache[7]||=createBaseVNode(`th`,{class:`w-10 h-8 bg-slate-100 border border-slate-200 text-xs text-slate-500`},null,-1),(openBlock(!0),createElementBlock(Fragment,null,renderList(columns.value,(col,colIdx)=>(openBlock(),createElementBlock(`th`,{key:col.key||colIdx,class:`min-w-[100px] h-8 bg-slate-100 border border-slate-200 text-xs font-medium text-slate-600 px-2`},[editingColumnHeader.value===colIdx?withDirectives((openBlock(),createElementBlock(`input`,{key:0,"onUpdate:modelValue":$event=>col.title=$event,class:`w-full bg-transparent text-center outline-none`,onBlur:_cache[1]||=$event=>editingColumnHeader.value=null,onKeydown:_cache[2]||=withKeys($event=>editingColumnHeader.value=null,[`enter`])},null,40,_hoisted_11)),[[vModelText,col.title]]):(openBlock(),createElementBlock(`span`,{key:1,onDblclick:$event=>editingColumnHeader.value=colIdx},toDisplayString(col.title||getColumnName(colIdx)),41,_hoisted_12))]))),128))])]),createBaseVNode(`tbody`,null,[(openBlock(!0),createElementBlock(Fragment,null,renderList(rows.value,(row,rowIdx)=>(openBlock(),createElementBlock(`tr`,{key:rowIdx},[createBaseVNode(`td`,_hoisted_13,toDisplayString(rowIdx+1),1),(openBlock(!0),createElementBlock(Fragment,null,renderList(columns.value,(col,colIdx)=>(openBlock(),createElementBlock(`td`,{key:col.key||colIdx,class:normalizeClass([`border border-slate-200 px-2 py-1`,selectedCell.value?.row===rowIdx&&selectedCell.value?.col===colIdx?`bg-blue-50 outline outline-2 outline-blue-500 -outline-offset-1`:`hover:bg-slate-50`]),onClick:$event=>selectCell(rowIdx,colIdx),onDblclick:$event=>editCell(rowIdx,colIdx)},[editingCell.value?.row===rowIdx&&editingCell.value?.col===colIdx?withDirectives((openBlock(),createElementBlock(`input`,{key:0,"onUpdate:modelValue":_cache[3]||=$event=>editingValue.value=$event,class:`w-full h-full bg-transparent outline-none`,onBlur:saveCell,onKeydown:[withKeys(saveCell,[`enter`]),withKeys(cancelEdit,[`escape`])],ref_for:!0,ref_key:`cellInput`,ref:cellInput},null,544)),[[vModelText,editingValue.value]]):(openBlock(),createElementBlock(`span`,_hoisted_15,toDisplayString(getCellValue(row,col.key)),1))],42,_hoisted_14))),128))]))),128))])])])],64))]))}};export{SpreadsheetEditor_default as default};