import{Di as e,f as t,ha as n,na as r}from"./index-DUz5oLRf.js";var i=`flow_workspace_state`,a=`flow_form_drafts`,o={id:`flow`,type:`flow`,title:`Workspace`,icon:`Home`,closable:!1};function s(e){let t={id:e.id,type:e.type,title:e.title,icon:e.icon,closable:e.closable,appId:e.appId,dynamic:e.dynamic,route:e.route,doctype:e.doctype,docName:e.docName,isNew:e.isNew};return e.data&&(t.data={},e.data.application&&(t.data.application={reference:e.data.application.reference,name:e.data.application.name,icon:e.data.application.icon,schema:e.data.application.schema,config:e.data.application.config,workflowDefinition:e.data.application.workflowDefinition}),e.data.initialData&&(t.data.initialData=e.data.initialData),e.data.dataId&&(t.data.dataId=e.data.dataId),e.data.isEdit!==void 0&&(t.data.isEdit=e.data.isEdit),e.data.reference&&(t.data.reference=e.data.reference),e.data.invoiceType&&(t.data.invoiceType=e.data.invoiceType),t.data.loading=!1,t.data.saving=!1),t}function c(e){let t={...e};return t.dynamic&&t.data&&(t.data.loading=!0,t.data.items=[],t.data.totalItems=0),t.unsaved=!1,t}const l=t(`workspace`,()=>{let t=n([o]),l=n(`flow`),u=n([]),d=n(!1),f=n({}),p=n({doctype:null,docName:null,timestamp:0}),m=e(()=>t.value.find(e=>e.id===l.value));function h(){if(!d.value){try{let e=localStorage.getItem(i);if(e){let n=JSON.parse(e);if(Array.isArray(n.openTabs)&&n.openTabs.length>0){let e=n.openTabs.some(e=>e.id===`flow`),r=n.openTabs.map(c);e||r.unshift(o),t.value=r}n.activeTabId&&t.value.some(e=>e.id===n.activeTabId)&&(l.value=n.activeTabId),Array.isArray(n.tabHistory)&&(u.value=n.tabHistory.filter(e=>t.value.some(t=>t.id===e)))}}catch(e){console.warn(`Failed to hydrate workspace state:`,e),t.value=[o],l.value=`flow`,u.value=[]}d.value=!0}}function g(){try{let e={openTabs:t.value.map(s),activeTabId:l.value,tabHistory:u.value.slice(-50)};localStorage.setItem(i,JSON.stringify(e))}catch(e){console.warn(`Failed to persist workspace state:`,e)}}function _(){try{let e=localStorage.getItem(a);e&&(f.value=JSON.parse(e))}catch(e){console.warn(`Failed to load form drafts:`,e),f.value={}}}function v(){try{localStorage.setItem(a,JSON.stringify(f.value))}catch(e){console.warn(`Failed to persist form drafts:`,e)}}function y(e,t=!0,n=null){return e?t?`new:${e}`:n?`edit:${e}:${n}`:null:null}function b(e,t,n=!0,r=null){let i=y(e,n,r);i&&(f.value[i]={data:t,doctype:e,isNew:n,docName:r,savedAt:new Date().toISOString()},v())}function x(e,t=!0,n=null){let r=y(e,t,n);return r&&f.value[r]||null}function S(e,t=!0,n=null){let r=y(e,t,n);return r?!!f.value[r]:!1}function C(e,t=!0,n=null){let r=y(e,t,n);r&&(delete f.value[r],v())}function w(){f.value={},localStorage.removeItem(a)}function T(e,t){p.value={doctype:e,docName:t,timestamp:Date.now()}}r([t,l],()=>{d.value&&g()},{deep:!0});function E(e){if(h(),t.value.find(t=>t.id===e.id)){l.value!==e.id&&u.value.push(l.value),l.value=e.id;return}u.value.push(l.value),t.value.push({...e,closable:e.closable!==!1}),l.value=e.id}function D(e){h();let n=t.value.findIndex(t=>t.id===e);if(n>-1&&t.value[n].closable!==!1&&(t.value.splice(n,1),u.value=u.value.filter(t=>t!==e),l.value===e)){if(u.value.length>0){let e=u.value.pop();if(t.value.some(t=>t.id===e)){l.value=e;return}}let e=Math.min(n,t.value.length-1);l.value=t.value[e]?.id||`flow`}}function O(e,n={}){h(),t.value.some(t=>t.id===e)&&(!n.skipHistory&&l.value!==e&&u.value.push(l.value),l.value=e)}function k(e){h(),t.value=e}function A(){if(u.value.length===0)return!1;let e=u.value.pop();return e&&t.value.some(t=>t.id===e)?(l.value=e,!0):A()}function j(){return u.value.length>0&&u.value.some(e=>t.value.some(t=>t.id===e))}function M(){localStorage.removeItem(i),localStorage.removeItem(a),t.value=[o],l.value=`flow`,u.value=[],f.value={}}return h(),_(),{openTabs:t,activeTabId:l,tabHistory:u,isHydrated:d,formDrafts:f,docSavedEvent:p,activeTab:m,openTab:E,closeTab:D,setActiveTab:O,reorderTabs:k,goBack:A,canGoBack:j,clearPersistedState:M,hydrateState:h,persistState:g,saveFormData:b,getFormData:x,hasFormData:S,clearFormData:C,clearAllFormDrafts:w,notifyDocSaved:T}});export{l as t};