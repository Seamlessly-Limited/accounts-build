import"./ConfigProvider-BwNXqMge.js";import"./useHideOthers-C416Re6d.js";import"./useId-BEfc-0Pq.js";import"./DialogPortal-913ieDuk.js";import"./Teleport-DrGXNRYb.js";import"./utils-BEsFB3CI.js";import"./DialogTitle-BUR1zqy5.js";import{a as e,i as t,n,o as r,r as i}from"./sheet-CqjRTU1B.js";import{Bi as a,Hi as o,Ki as s,Li as c,Mi as l,Oa as u,Pa as d,Ra as f,Ui as p,Vi as m,Wi as h,ba as g,ca as _,h as v,ha as y,ji as b,o as x,oa as S,qi as C,xa as w,zt as T}from"./index-CTHZVx0Q.js";import{t as E}from"./button-DTHLpYkO.js";var ee={key:0,class:`flex justify-center py-8`},te={key:1,class:`space-y-6`},ne={class:`bg-gray-50 rounded-lg p-4 border border-gray-100`},D={class:`grid grid-cols-2 gap-4 text-sm`},O={class:`font-semibold`},k={class:`font-semibold text-amber-600`},A={key:0,class:`border rounded-lg p-4 space-y-4`},j={class:`grid gap-4`},M={class:`space-y-2`},N={class:`space-y-2`},P={class:`space-y-2`},F={class:`space-y-4`},I={key:0,class:`text-sm text-gray-500 italic text-center py-4`},L={key:1,class:`space-y-2`},R={class:`font-medium`},z={class:`text-xs text-gray-500`},B={class:`text-right`},V={class:`font-medium`},H={__name:`PaymentAllocationSheet`,props:{open:Boolean,payment:{type:Object,required:!0}},emits:[`update:open`,`refresh`],setup(H,{emit:U}){let W=H,G=U,{toast:K}=v(),q=u(!1),J=u(!1),Y=u([]),X=u({target_type:`Sales Invoice`,target_id:``,amount:0}),Z=a(()=>{if(!W.payment)return 0;let e=Y.value.filter(e=>e.status!==`Cancelled`).reduce((e,t)=>e+(Number(t.allocated_amount)||0),0);return Math.max(0,(W.payment.amount||0)-e)}),re=a(()=>X.value.target_id&&X.value.amount>0&&X.value.amount<=Z.value);async function Q(){if(W.payment?.name){q.value=!0;try{Y.value=(await x.get(`/org/doc/Payment Allocation`,{params:{filters:JSON.stringify({payment:W.payment.name}),fields:JSON.stringify([`name`,`allocated_amount`,`target_type`,`target_id`,`status`,`currency`,`allocation_date`,`id`])},authorizeRequest:!0,organisationAware:!0})).data?.data||[]}catch(e){console.error(e),Y.value=[]}finally{q.value=!1}}}async function ie(){J.value=!0;try{await x.post(`/org/payments/${W.payment.id}/allocations`,{target_type:X.value.target_type,target_id:X.value.target_id,amount:X.value.amount},{authorizeRequest:!0,organisationAware:!0}),K({title:`Draft Created`,variant:`success`}),X.value={target_type:`Sales Invoice`,target_id:``,amount:0},await Q()}catch(e){K({title:`Failed`,description:e.response?.data?.message||e.message,variant:`destructive`})}finally{J.value=!1}}async function ae(e){if(e.id)try{await x.post(`/org/payments/allocations/${e.id}/submit`,{},{authorizeRequest:!0,organisationAware:!0}),K({title:`Allocated!`,variant:`success`}),await Q(),G(`refresh`)}catch(e){K({title:`Submission Failed`,description:e.response?.data?.message||e.message,variant:`destructive`})}}let $=(e,t)=>new Intl.NumberFormat(`en-NG`,{style:`currency`,currency:t||`NGN`}).format(e||0),oe=e=>e?new Date(e).toLocaleDateString():`-`;return y(()=>W.open,e=>{e&&Q()}),(a,u)=>(S(),o(d(r),{open:H.open,"onUpdate:open":u[3]||=e=>a.$emit(`update:open`,e)},{default:g(()=>[C(d(e),{class:`w-full sm:max-w-xl overflow-y-auto`},{default:g(()=>[C(d(i),{class:`mb-6`},{default:g(()=>[C(d(n),null,{default:g(()=>[...u[4]||=[s(`Payment Allocations`,-1)]]),_:1}),C(d(t),null,{default:g(()=>[...u[5]||=[s(` Manage how this payment is applied to invoices. `,-1)]]),_:1})]),_:1}),q.value?(S(),h(`div`,ee,[C(d(T),{class:`h-8 w-8 animate-spin text-gray-400`})])):(S(),h(`div`,te,[m(`div`,ne,[m(`div`,D,[m(`div`,null,[u[6]||=m(`span`,{class:`text-gray-500 block`},`Payment Amount`,-1),m(`span`,O,f($(H.payment.amount,H.payment.currency)),1)]),m(`div`,null,[u[7]||=m(`span`,{class:`text-gray-500 block`},`Unallocated`,-1),m(`span`,k,f($(Z.value,H.payment.currency)),1)])])]),Z.value>0?(S(),h(`div`,A,[u[13]||=m(`h3`,{class:`font-medium text-sm text-gray-900`},`New Allocation`,-1),m(`div`,j,[m(`div`,M,[u[9]||=m(`label`,{class:`text-xs font-medium text-gray-500`},`Target Type`,-1),w(m(`select`,{"onUpdate:modelValue":u[0]||=e=>X.value.target_type=e,class:`w-full border rounded-md p-2 text-sm bg-white`},[...u[8]||=[m(`option`,{value:`Sales Invoice`},`Sales Invoice`,-1),m(`option`,{value:`Credit Note`},`Credit Note`,-1)]],512),[[b,X.value.target_type]])]),m(`div`,N,[u[10]||=m(`label`,{class:`text-xs font-medium text-gray-500`},`Target ID`,-1),w(m(`input`,{"onUpdate:modelValue":u[1]||=e=>X.value.target_id=e,type:`text`,placeholder:`e.g. INV-2024-001`,class:`w-full border rounded-md p-2 text-sm`},null,512),[[l,X.value.target_id]])]),m(`div`,P,[u[11]||=m(`label`,{class:`text-xs font-medium text-gray-500`},`Amount to Allocate`,-1),w(m(`input`,{"onUpdate:modelValue":u[2]||=e=>X.value.amount=e,type:`number`,step:`0.01`,class:`w-full border rounded-md p-2 text-sm`},null,512),[[l,X.value.amount,void 0,{number:!0}]])]),C(d(E),{onClick:ie,disabled:J.value||!re.value,class:`w-full`},{default:g(()=>[J.value?(S(),o(d(T),{key:0,class:`mr-2 h-4 w-4 animate-spin`})):p(``,!0),u[12]||=s(` Allocate `,-1)]),_:1},8,[`disabled`])])])):p(``,!0),m(`div`,F,[u[15]||=m(`h3`,{class:`font-medium text-sm text-gray-900`},`History`,-1),Y.value.length===0?(S(),h(`div`,I,` No allocations yet. `)):(S(),h(`div`,L,[(S(!0),h(c,null,_(Y.value,e=>(S(),h(`div`,{key:e.name,class:`flex items-center justify-between p-3 border rounded-lg bg-white text-sm`},[m(`div`,null,[m(`div`,R,f(e.target_type)+` - `+f(e.target_id),1),m(`div`,z,f(e.status)+` â€¢ `+f(oe(e.allocation_date)),1)]),m(`div`,B,[m(`div`,V,f($(e.allocated_amount,e.currency)),1),e.status===`Draft`?(S(),o(d(E),{key:0,onClick:t=>ae(e),size:`xs`,variant:`outline`,class:`mt-1 h-6 text-xs border-green-200 text-green-700 hover:bg-green-50`},{default:g(()=>[...u[14]||=[s(` Submit `,-1)]]),_:1},8,[`onClick`])):p(``,!0)])]))),128))]))])]))]),_:1})]),_:1},8,[`open`]))}};export{H as default};